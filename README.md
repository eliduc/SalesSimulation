# Эмулятор продаж и статмодель распродажи

Два настольных приложения (GUI на **Tkinter** + графики на **Matplotlib**) для имитации распродажи и статистического анализа спроса по ценам:

- `emulation_uniform.py` — интерактивная **эмуляция продаж** с шагами цены, анимацией, режимом «равномерного вымывания» остатков, автоподбором финальной цены под заданную вероятность *sold‑out* и экспортом результатов в CSV/XLSX.
- `statmodel_pro.py` — загрузка отчёта из эмулятора, **аппроксимация функции спроса** *f(p)*, визуализация *f(p)* и *p·f(p)* (сглаженная отрисовка), **моделирование** кумулятивных продаж/выручки с доверительными интервалами.

> Версии: `emulation_uniform.py` v1.6.1; `statmodel_pro.py` v3.41.

---

## Содержание

- [Быстрый старт](#быстрый-старт)  
- [Требования и установка](#требования-и-установка)  
- [Структура репозитория](#структура-репозитория)  
- [Приложение 1: Эмулятор продаж (`emulation_uniform.py`)](#приложение-1-эмулятор-продаж-emulation_uniformpy)  
  - [Функциональность](#функциональность)  
  - [Интерфейс и рабочий процесс](#интерфейс-и-рабочий-процесс)  
  - [Равномерное вымывание остатков](#равномерное-вымывание-остатков)  
  - [Финальный интервал: sold‑out и «Гарантия»](#финальный-интервал-soldout-и-гарантия)  
  - [Экспорт и формат данных](#экспорт-и-формат-данных)  
- [Приложение 2: Статмодель (`statmodel_pro.py`)](#приложение-2-статмодель-statmodel_propy)  
  - [Назначение и возможности](#назначение-и-возможности)  
  - [Загрузка и графики](#загрузка-и-графики)  
  - [Аппроксимация спроса и моделирование](#аппроксимация-спроса-и-моделирование)  
- [Репродуцируемость и производительность](#репродуцируемость-и-производительность)  
- [Диагностика и частые сообщения](#диагностика-и-частые-сообщения)  
- [История версий (кратко)](#история-версий-кратко)

---

## Быстрый старт

```bash
# 1) создать и активировать изолированное окружение
python -m venv .venv
# Windows:
.\.venv\Scripts\activate
# macOS / Linux:
source .venv/bin/activate

# 2) установить зависимости
pip install -U pip
pip install numpy matplotlib pandas scipy numba openpyxl xlsxwriter

# 3) запустить эмулятор продаж
python emulation_uniform.py

# 4) выполнить шаги/серии и сохранить результаты (results.xlsx/CSV)

# 5) запустить статмодель и загрузить results.xlsx
python statmodel_pro.py
```

> **Примечания по окружению**
> - Оба приложения используют графический backend **TkAgg** и требуют установленный **Tkinter** (обычно входит в дистрибутив Python; на Linux при необходимости установите пакет `python3-tk`).  
> - `numba` **опционален**: ускоряет «быстрые» симуляции; при его отсутствии всё работает на чистом NumPy.  
> - Для экспорта Excel используется `openpyxl` или `xlsxwriter`; при их отсутствии всегда создаётся `results.csv` (+ `settings.csv`).

---

## Требования и установка

**Платформы:** Windows / macOS / Linux (нужен настольный GUI).  
**Рекомендуемый Python:** 3.9+.

**Минимальные зависимости:**
- Общие: `numpy`, `matplotlib`, `tkinter` (системная).  
- Эмулятор: `pandas` *(для Excel-экспорта)*, `numba` *(опционально для ускорения)*.  
- Статмодель: `pandas`, `scipy` (оптимизация и PCHIP).  
- Excel: `openpyxl` и/или `xlsxwriter` *(желательно)*.

Установка одной командой:
```bash
pip install numpy matplotlib pandas scipy numba openpyxl xlsxwriter
```

---

## Структура репозитория

```
.
├── emulation_uniform.py   # Эмулятор продаж, GUI, экспорт результатов
├── statmodel_pro.py       # Статмодель, загрузка Sales-листа из results.xlsx
├── results.xlsx           # (появится после сохранения в эмуляторе)
├── results.csv            # (резерв/альтернатива)
└── scenario.json          # (автосохранение сценария эмулятора)
```

---

## Приложение 1: Эмулятор продаж (`emulation_uniform.py`)

### Функциональность

- **Пошаговая распродажа** на горизонте проекта: базовая цена постоянна внутри интервала; результат — продажи/выручка по шагам и типам. Экспорт в `results.csv` и при наличии библиотек в `results.xlsx` с листами **Sales** и **Settings**.  
- **Режим «Равномерное вымывание»**: автоматический проход по интервалам с подстройкой базовой цены обратной связью на **остатки** для выравнивания распродажи во времени.  
- **Финальный интервал — sold‑out**: при включённом флаге «**Полные продажи**» цена последнего интервала подбирается автоматически под целевую вероятность sold‑out. Опция «**Гарантия**» позволяет довычесть остаток по минимально допустимой цене в коридоре.  
- **Анимация спроса** (опционально): визуальная демонстрация «покупателей», витрин типов и принятия решений; для расчётов не требуется.  
- **Калибровка параметров покупателей** *(логнормальные a,b)* по целевой функции, с прогресс‑диалогом и автоподстановкой параметров в сценарий.

### Интерфейс и рабочий процесс

1. **Проект** — задайте общий горизонт (дни), длину ценового интервала (дни), начальную базовую цену и допустимый коридор изменения (±%). Подсказка показывает валидный диапазон цен.  
2. **Типы** — число типов (1–5), качество (%), коэффициент цены (% к базе), количество объектов. Доступны «Распределить поровну» и «Коэф.=100%+(кач-100%)/2». Сумма количеств по типам должна равняться общему числу объектов.  
3. **Покупатели** — параметры интенсивности прихода (λ) и трендов/сезонности, бюджетные границы, логнормальные распределения чувствительности к качеству/цене (μ,σ для `a` и `b`), параметр τ в softmax. Кнопка **«Калибровать a,b»** запускает подбор.  
4. **Симуляция** — задайте число симуляций, **Вероятность sold‑out**, флаги **«Полные продажи»** и **«Гарантия»**, коэффициент обратной связи `k_fb` для равномерного вымывания. Блок **Шаги**: «Цена для шага» → «Сделать шаг» / «Отменить шаг» / «Начать снова».  
5. **Статус** — журнал событий (предупреждения, экспорт файлов, завершение интервалов и пр.).  
6. **Меню «Файл»** — экспорт сценария (`scenario.json`), сохранение XLSX/CSV, сброс параметров, выход (с автосохранением сценария).

**Валидации:** диапазоны значений для полей (цены, λ‑рост, σ, τ, вероятность sold‑out, k_fb, суммы по типам и т. п.) с понятными сообщениями об ошибках.

### Равномерное вымывание остатков

Режим **«Равномерное вымывание»** запускает серию шагов без анимации, корректируя базовую цену по формуле обратной связи **по остаткам** (v1.6.1):

- Пусть `m_k` — фактический остаток перед шагом *k*, `R_u = (N_total/N_steps)*(N_steps−k+1)` — равномерный «целевой» остаток.  
- `diff_k = (m_k − R_u) / R_u`  
- `P_k = P_(k−1) * (1 − k_fb * diff_k)` с последующим ограничением **внутри ценового коридора**.  
- На **последнем** интервале при активной опции «Полные продажи» используется **автоподбор** цены под целевую вероятность sold‑out.

### Финальный интервал: sold‑out и «Гарантия»

- **«Полные продажи»** включены — на **последнем** интервале выполняется автоподбор базовой цены для достижения заданной вероятности sold‑out (по результатам моделирования).  
- Доп. опция **«Гарантия»** — если после последнего интервала остались остатки, они «досчитываются» по **минимально допустимой базовой цене** (нижняя граница коридора), умноженной на коэффициент типа. Этот довычет фиксируется в отчёте.  
- Если **«Полные продажи»** выключены — последний интервал симулируется как обычный (без автоподбора цены и без довычета).

### Экспорт и формат данных

- **CSV** — создаётся всегда: `results.csv`.  
- **Excel** — `results.xlsx` с листами:
  - **Sales**: по шагам — `step, start_day, end_day, base_price`, далее блоки `sales_k*` и `cum_sales_k*`, суммарные `sales_total`, `cum_sales_total`, блоки `rev_k*` и `cum_rev_k*`, суммарные `rev_total`, `cum_rev_total`, затем `remaining_k*`. Порядок колонок стабильный.  
  - **Settings**: снапшот сценария (включая `price_schedule` и параметры типов/модели). При отсутствии Excel‑движка создаётся `settings.csv` рядом с `results.csv`.  

Кнопка «Сохранить XLSX/CSV…» позволяет вывести итоговый файл в выбранное место.

---

## Приложение 2: Статмодель (`statmodel_pro.py`)

### Назначение и возможности

- Загружает **лист `Sales`** из `results.xlsx`, фильтрует «пустые» строки по `remaining_k*`, восстанавливает пропуски `base_price` интерполяцией.  
- Выполняет **аппроксимацию функции спроса `f(p)`** (кусочно‑линейная семья на адаптивных узлах) по кумулятивам.  
- Рисует **f(p)** и **p·f(p)** на правом графике **строго в диапазоне `[p_min, p_max]`**; для **отрисовки** применён **PCHIP** (shape‑preserving cubic), чтобы убрать визуальные «изломы» (в расчётах используется линейная интерполяция).  
- Запускает **моделирование**: детерминированная траектория (отсечение спроса остатком) + доверительные интервалы по числу симуляций и уровню доверия.

### Загрузка и графики

1) Нажмите **«Выбрать»** и укажите `results.xlsx` (по умолчанию — в корне), затем **«Загрузить»**.  
2) Появятся три графика (слева): **Цена**, **Кумулятивные продажи**, **Кумулятивная выручка** (по серединам интервалов). Справа — окно для `f(p)` и `p·f(p)` (появятся после аппроксимации).

### Аппроксимация спроса и моделирование

- **Аппроксимация** — кнопка **«Аппрокс. спроса»**: подбираются узловые значения `q_k` на сетке по цене, с ограничениями монотонности и доходности; минимизируется ошибка по кумулятивам продаж/выручки с регуляризацией. На правом графике `f(p)` и `p·f(p)` рисуются по PCHIP на **[p_min, p_max]** (только отрисовка, расчёты — линейные).  
- **Моделирование** — задайте **ДИ** (например, `0.95`) и **число симуляций** (например, `1000`), затем нажмите **«Моделирование»**. Слева появятся:
  - «детерминистическая» траектория кумулятивных продаж/выручки;  
  - полупрозрачные **доверительные интервалы** из симуляций.

---

## Репродуцируемость и производительность

- **Случайные числа**: в ключевых местах используются фиксированные сиды/ГПСЧ‑объекты, что повышает воспроизводимость между запусками.  
- **Ускорение**: при наличии `numba` интенсивные симуляции выполняются в jit‑режиме; иначе — чистый NumPy. Ускорение особенно заметно при больших `sims`.  
- **Графика**: backend `TkAgg`; убедитесь, что **Tkinter** установлен в системе.

---

## Диагностика и частые сообщения

- «**Ошибка параметров / Ошибка цены / Число типов 1..5 / …**» — корректируйте ввод по тексту сообщения.  
- «**Сначала дождитесь завершения текущей анимации шага**» — нельзя параллелить действия во время анимации. Отключите анимацию или дождитесь завершения.  
- «**Нет данных / Нет цен**» при калибровке — выполните хотя бы один шаг/установите цену.  
- **Не создался `results.xlsx`** — установите `openpyxl`/`xlsxwriter`/`pandas` или используйте `results.csv` + `settings.csv`.  
- **Статмодель сообщает об отсутствующих колонках** — загружайте именно лист **Sales** из файла `results.xlsx`, созданного эмулятором (не меняйте названия колонок).

---

## История версий (кратко)

- **`emulation_uniform.py` v1.6.1** — обновлён алгоритм «равномерного вымывания»: обратная связь по **остаткам** `m_k` к равномерному остатку `R_u` (`diff_k`, `P_k`), уточнена логика финального интервала и опция «Гарантия». Графики кумулятивов перерисовываются после каждого шага; экспорт `sales_total`/`rev_total` и порядок колонок синхронизированы.  
- **`statmodel_pro.py` v3.41** — правый график строится строго на `[p_min, p_max]`; отрисовка `f(p)` и `p·f(p)` — **PCHIP** (сохранение формы), при этом расчёты/симуляции остаются на **линейной** интерполяции.

---

### Краткий чек‑лист действий «с нуля»

1. Установите Python 3.9+ и зависимости: `numpy`, `matplotlib`, `pandas`, `scipy`, `numba`, `openpyxl`, `xlsxwriter`.  
2. Запустите `emulation_uniform.py`, настройте Проект/Типы/Покупателей, сделайте шаги вручную или включите «Равномерное вымывание». При необходимости выполните калибровку `a,b`, включите «Полные продажи» (+ «Гарантия»). Сохраните результаты.  
3. Запустите `statmodel_pro.py`, загрузите `results.xlsx`, выполните «Аппрокс. спроса», затем «Моделирование» с желаемым ДИ и числом симуляций. Сопоставьте модели с данными на графиках.
